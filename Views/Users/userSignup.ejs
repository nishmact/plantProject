<%- include('../Layouts/header.ejs') %>

<!-- Section: Design Block -->
<section class="">
    <!-- Jumbotron -->
    <div class="px-3 py-4 px-md-5 text-center text-lg-start" style="background-image: url('image/imgbacks.jpg'); background-size: 100%;">
      <div class="container">
        <div class="row gx-lg-5 align-items-center">
          
            <div class="" style="background-color: rgba(255,255,255,0.5); border-radius: 10%; margin-left: 700px; width: 500px; height: 650px; margin-top: px;">
              <div class="card-body py-3 px-md-5">
                <form id="signupForm" name="signupForm">
                    <h3 style="margin-left: 100px; margin-bottom: 20px; margin-top: 0px; font-weight: bold; color: black;">Sign Up</h3>

                  <!-- Fullname input -->
                  <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="name" class="form-control" name="name">
                    <p style="color: red;" id="error-name"></p>
                  </div>

                    <!-- Email input -->
                    <div class="form-group">
                      <label for="username" class="form-label">Email address</label>
                      <input type="email" id="email" class="form-control" name="email">
                      <p style="color: red;" id="error-email"></p>
                    </div>  

                        <!-- Mobile number input -->
                        <div class="form-group">
                          <label class="form-label">Phone number</label>
                          <input type="tel" id="mobile" class="form-control" name="mobile">
                          <p style="color: red;" id="error-mobile"></p>
                        </div>
                         
                        <!-- Password input -->
                        <div class="form-group">
                          <label class="form-label">Password</label>
                          <input type="password" id="password" class="form-control" name="password">
                          <p style="color: red;" id="error-password"></p>
                        </div>

                        <div class="form-group">
                          <label class="form-label">Referral Code (Optional)</label>
                          <input type="text" id="referralCode" class="form-control" name="referralCode">
                          <p style="color: red;" id="error-referralCode"></p>
                        </div>

                  <!-- Submit button -->
                  <button type="submit" class="btn  btn-block " style="margin-bottom: 100px; background-color: #083b3b; margin-top: 5px;">
                    Submit
                  </button>
                  <h6 class="text-danger text-center" id="signupMessage"></h6>
                </form>

                <!--///////////////////////////////////////////////////////////////////////////////-->

                <form id="signupFormOtp" style="display: none;">
                  <div class="form-outline mb-4">
                    <label class="form-label">Enter Your OTP</label>
                    <input id="otpInput" class="form-control form-control-lg" name="otp"/>                    
                  </div>
                      <h6 id="otpMessage" class="text-danger text-center "></h6>
                      <div id="otpExpireTime"  style="color: red;"></div>
                  <div class="pt-1 mb-4">
                    <button type="submit" id="otpSubmitButton" class="btn btn-lg btn-block" >Submit OTP</button>                    
                  </div>                  
                </form>
                <button type="button" id="otpResendButton" class="btn btn-danger btn-lg btn-block" >Resend OTP</button>

              </div>
            </div>
          
        </div>
      </div>
    </div>
    <!-- Jumbotron -->
  </section>
  <!-- Section: Design Block -->

  <script>
    function validate(){     
    var name = document.getElementById("name").value;                                                    
    var email = document.getElementById("email").value;
    var mobile = document.getElementById("mobile").value;
    var password = document.getElementById("password").value;
    var flag=true
    document.getElementById("error-name").innerText = "";
    document.getElementById("error-email").innerText = "";
    document.getElementById("error-mobile").innerText = "";
    document.getElementById("error-password").innerText = "";

    if(name ===""){
      document.getElementById("error-name").innerText = "Please enter Fullname";
      flag= false;
    }

    if(email ===""){
      document.getElementById("error-email").innerText = "Please enter Username";
      flag= false;
    }

    if(mobile ===""){
      document.getElementById("error-mobile").innerText = "Please enter Mobile number";
      flag= false;
    }else if(mobile.length !== 10){
      document.getElementById("error-mobile").innerText = "Please enter Proper number";
      flag= false;
    }

    if (password === "") {
            document.getElementById("error-password").innerText = "Please enter Password";
            flag = false;
        } else if (!isPasswordValid(password)) {
            document.getElementById("error-password").innerText = "Password must contain at least one uppercase letter, one lowercase letter, one number, and one special character.";
            flag = false;
        
          }
    
       return flag;
  }


  function isPasswordValid(password) {
        // Password must contain at least one uppercase letter, one lowercase letter, one number, and one special character.
        var regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
        return regex.test(password);
    }



    const otpResendButton=document.getElementById('otpResendButton')
    otpResendButton.style.display="none"

  function updateOTPTimer(expireTime) {
      const otpSubmitButton=document.getElementById('otpSubmitButton')
      const otpExpireTimeElement = document.getElementById('otpExpireTime');
      otpResendButton.disabled=true
      otpSubmitButton.disabled=false
      const timerInterval = setInterval(() => {
      const currentTime = new Date().getTime();
      const timeDifference = expireTime - currentTime;
        if (timeDifference <= 0) {          
          //otpExpireTimeElement.style.color = 'red';
          otpExpireTimeElement.innerHTML = 'OTP Expired';
          otpSubmitButton.disabled=true
          otpResendButton.disabled=false
          clearInterval(timerInterval);
          return;
        }  
        const minutes = Math.floor((timeDifference % (3000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeDifference % (3000 * 60)) / 1000); 
        //otpExpireTimeElement.style.color = 'black'; 
        otpExpireTimeElement.innerHTML = `OTP will expire in ${minutes}m ${seconds}s`;
      }, 1000);
    }

  const signupForm=document.getElementById('signupForm')
  const signupFormOtp=document.getElementById('signupFormOtp')
  otpResendButton.addEventListener('click',submitSignupForm)
  signupForm.addEventListener('submit',submitSignupForm)
  
    async function submitSignupForm(event){
    event.preventDefault()
    const status=validate()
    if(status){
      const formdata= new FormData(signupForm)
      const signupMessage=document.getElementById('signupMessage')
      try{
        const response=await fetch('/userSignup',{
          method:"POST",
          body:formdata
        })
        if(response.ok){
          const result=await response.json()
          signupMessage.innerText=result.message
          if(result.message=="Signup success"){
            signupFormOtp.style.display="block"
            otpResendButton.style.display="block"
            signupForm.style.display="none"
            const otpExpireTime = result.otpExpireTime
            const expireTime = new Date(otpExpireTime);            
            updateOTPTimer(expireTime);
          }
        }
      }catch(err){
        console.log(err.message)
      }
    }
  }


  signupFormOtp.addEventListener('submit',submitSignupOtp)
  async function submitSignupOtp(event){
  const otpInput=document.getElementById('otpInput')
  const otpMessage=document.getElementById('otpMessage')
  const formdata= new FormData(signupFormOtp)
    event.preventDefault()
    if(otpInput.value==""){
      otpMessage.innerText="Please Enter the OTP"
    }else{
      const response=await fetch('/userSignup',{
          method:"POST",
          body:formdata
        })
        if(response.ok){
          const result=await response.json()          
          if(result.message=="Signup success"){
            window.location.href='/'            
          }else{
            otpMessage.innerText=result.message
          }
        }
    }
  }

</script>


  <%- include('../Layouts/footer.ejs') %>